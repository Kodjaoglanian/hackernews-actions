name: Hacker News to Discord

on:
  schedule:
    - cron: "0 9 * * *"  # Roda todo dia 9h UTC
  workflow_dispatch:

jobs:
  send-news:
    runs-on: ubuntu-latest  # Use runner oficial para garantir acesso a secrets
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: pip install requests

      - name: Verificar segredo (debug)
        run: echo "DISCORD_WEBHOOK_URL length: ${#DISCORD_WEBHOOK_URL}"
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}

      - name: Send Hacker News to Discord
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          python << 'EOF'
          import os
          import requests

          webhook_url = os.environ.get("DISCORD_WEBHOOK_URL")
          if not webhook_url:
              raise Exception("DISCORD_WEBHOOK_URL nÃ£o definido")

          top_stories = requests.get("https://hacker-news.firebaseio.com/v0/topstories.json").json()[:5]
          mensagens = []

          for story_id in top_stories:
              story = requests.get(f"https://hacker-news.firebaseio.com/v0/item/{story_id}.json").json()
              title = story.get('title', 'Sem tÃ­tulo')
              url = story.get('url', f"https://news.ycombinator.com/item?id={story_id}")
              mensagens.append(f"**{title}**\n{url}\n")

          payload = {
              "content": "ðŸ“° **Top Hacker News do dia:**\n\n" + "\n".join(mensagens)
          }

          resp = requests.post(url=webhook_url, json=payload)
          resp.raise_for_status()
          print("âœ… NotÃ­cias enviadas com sucesso!")
          EOF
