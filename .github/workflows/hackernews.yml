name: Hacker News to Discord

on:
  schedule:
    - cron: "0 9 * * *" # todo dia 09:00 UTC
  workflow_dispatch:

jobs:
  send-news:
    runs-on: ubuntu-latest

    steps:
      - name: Validate Discord webhook
        run: |
          if [ -z "${{ secrets.DISCORD_WEBHOOK_URL }}" ]; then
            echo "Error: DISCORD_WEBHOOK_URL is not set!"
            exit 1
          fi
          echo "Discord webhook configuration validated."

      - name: Fetch top Hacker News and send to Discord
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          TOP_STORIES=$(curl -s https://hacker-news.firebaseio.com/v0/topstories.json | jq '.[0:5]')
          MESSAGES="ðŸ“° **Top Hacker News do dia:**\n\n"

          for ID in $(echo "$TOP_STORIES" | jq -r '.[]'); do
            STORY=$(curl -s "https://hacker-news.firebaseio.com/v0/item/$ID.json")
            TITLE=$(echo "$STORY" | jq -r '.title // "Sem tÃ­tulo"')
            URL=$(echo "$STORY" | jq -r '.url // ("https://news.ycombinator.com/item?id="+(.id|tostring))')
            MESSAGES+="**$TITLE**\n$URL\n\n"
          done

          ESCAPED_MESSAGE=$(echo -e "$MESSAGES" | sed ':a;N;$!ba;s/\n/\\n/g')

          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"content\": \"$ESCAPED_MESSAGE\"}" \
               "$DISCORD_WEBHOOK_URL"
